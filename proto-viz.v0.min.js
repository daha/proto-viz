// Copyright (c) 2012, David Haglund, license https://github.com/daha/proto-viz/blob/master/LICENSE
(function(){protoViz={},protoViz.Packet=function(e){"use strict";function i(e,t){return"translate("+e.offset*n+","+e.line*n+")"}function s(e){return e.reduce(function(e,t){return t.offset=e.offset%8,t.line=Math.floor(e.offset/8),e.list.push(t),e.offset+=t.length,e.bytes=Math.ceil(e.offset/8),e},{list:[],offset:0,bytes:0})}function o(e){return"translate("+e.length*n/2+","+n/2*1.2+")"}var t=this,n=50,r=d3.select(e).append("svg").attr("title","a packet").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").style("border","solid 1px #000");this.update=function(e){var t=s(e),u=t.length,a=8*n,f=t.bytes*n,l=r.attr("width",a).attr("height",f),c=l.selectAll("g.bit").data(t.list).enter().append("g").attr("transform",i);c.append("rect").attr("width",function(e){return e.length*n}).attr("height",n).style("stroke","#555").style("stroke-width","2px").style("fill",function(e){return e.color||"#fff"}),c.append("text").style("font-size","0.8em").style("fill","#000").attr("text-anchor","middle").attr("transform",o).text(function(e){var t="";return e.field!==""&&(t+=e.field,e.value!==""&&(t+=" = ")),e.value!==""&&(t+=e.value),t})},this.json=function(e){d3.json(e,function(e){t.update(e)})}},protoViz.Window=function(e){"use strict";function g(e){return"translate("+e.offset+",0)"}function y(e){return e.offset+e.width/2}function b(e){return"translate(0,55.5)"}function w(e){return"translate("+e.x+",55.5)"}function E(e){return"translate("+e.width/2+","+(r/2+o/2.5)+")"}function S(e){return e.reduce(function(e,t){return t.hasOwnProperty("width")||(t.width=i),t.offset=e.width,t.hasOwnProperty("id")||(t.id=e.count),t.hasOwnProperty("arrow")&&t.arrow.forEach(function(n,r){e.arrows[l(n)]={text:n,index:r,x:y(t)}}),t.hasOwnProperty("label")&&e.labels.push({text:t.label,x:y(t)}),t.arrow&&(e.maxArrowLabels=Math.max(t.arrow.length,e.maxArrowLabels)),e.list.push(t),e.width+=t.width,e.count+=1,e},{list:[],arrows:[],labels:[],width:0,count:0,maxArrowLabels:0})}var t=this,n=0,r=50,i=50,s=15,o=s,u=s,a=s,f=2e3,l=d3.scale.ordinal().range(d3.range(10)),c={ack:"#4DAF4A",pending:"#FF7F00",nack:"#E41A1C",unused:"#377EB8"},h=[],p=0,d=d3.select(e).append("svg").attr("title","a packet").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg"),v=d.append("g").attr("transform","translate(5,5)"),m=function(e){return e.data};v.append("defs").append("marker").attr("id","ArrowFillLeft").attr("viewBox","0 0 10 10").attr("refX",5).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerwidth",18).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M 10 0 L 0 5 L 10 10 z"),this.setGetDataFunction=function(e){m=e},this.show=function(){t.update(m(h[p]))},this.updateMulti=function(e){h=e,p=0,t.show()},this.next=function(){p=(p+1)%h.length,t.show()},this.prev=function(){var e=(p-1)%h.length;e>=0&&(p=e),t.show()},this.update=function(e){var t,i,s,l,h,p,m=S(e),y=m.length,x=m.width+10,T=r+Math.max(n,m.maxArrowLabels)*u+65;n=m.maxArrowLabels,d.attr("width",x).attr("height",T),s=v.selectAll("g.boxes").data(m.list),l=s.enter().append("g").attr("class","boxes").attr("transform",g),l.append("rect").style("fill","#fff"),l.append("text").style("font-size",o.toString()+"px").style("fill",function(e){return e.textColor||"#000"}).attr("transform",E).attr("text-anchor","middle").text(function(e){return e.id}),s.select("rect").attr("width",function(e){return e.width}).attr("height",r).style("border","solid 1px #000").style("stroke","#000").style("stroke-width","2px").transition().duration(f).style("fill",function(e){return e.color||c[e.type]||c.unused}),s.exit().remove(),h=v.selectAll("g.arrows").data(m.arrows),p=h.enter().append("g").attr("class","arrows").attr("transform",b),p.append("line").attr("y2",function(e){return 45.5}),p.append("text").attr("dy",function(e){return 60+u*e.index}),h.transition().duration(f).attr("transform",w),h.select("line").attr("y2",function(e){return 45.5}).attr("fill","none").attr("stroke","#000").attr("stroke-width",3).attr("marker-start","url(#ArrowFillLeft)"),h.select("text").style("font-size",u.toString()+"px").style("fill","#000").attr("text-anchor","middle").text(function(e){return e.text}).transition().duration(f).attr("dy",function(e){return 60+u*e.index}),h.exit().remove(),t=v.selectAll("g.label").data(m.labels),i=t.enter().append("g").attr("class","label").attr("transform",b),i.append("text").attr("dy",a),t.transition().duration(f).attr("transform",w),t.select("text").style("font-size",a.toString()+"px").style("fill","#000").attr("text-anchor","middle").text(function(e){return e.text}).transition().duration(f),t.exit().remove()},this.json=function(e){d3.json(e,function(e){t.update(e)})}}})();